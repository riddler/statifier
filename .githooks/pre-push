#!/bin/bash

# Git pre-push hook to run validation pipeline
# This prevents pushing code that fails known tests or linting

set -e

echo "ğŸ” Running pre-push validation pipeline..."

# Run formatting check
echo "ğŸ“ Checking code formatting..."
if ! mix format --check-formatted; then
    echo "âŒ Code formatting issues found. Running 'mix format' to fix..."
    mix format
    
    # Check if files were actually changed by formatting
    if ! git diff --quiet; then
        echo "ğŸ“ Code has been automatically formatted."
        echo "ğŸ”„ Please commit the formatting changes and push again:"
        echo "   git add ."
        echo "   git commit -m 'Auto-format code with mix format'"
        echo "   git push"
        exit 1
    else
        echo "âœ… No files needed formatting changes."
    fi
fi

# Run regression tests (critical - these should never break)
echo "ğŸ§ª Running regression tests..."
if ! mix test.regression; then
    echo "âŒ Regression tests failed. These tests should always pass!"
    exit 1
fi

# Run static analysis
echo "ğŸ” Running static analysis (Credo)..."
if ! mix credo --strict; then
    echo "âŒ Credo analysis failed. Fix issues before pushing."
    exit 1
fi

# Run type checking (optional - can be slow)
# Uncomment if you want type checking in the pre-push hook
# echo "ğŸ”¬ Running type checking (Dialyzer)..."
# if ! mix dialyzer; then
#     echo "âŒ Dialyzer type checking failed."
#     exit 1
# fi

echo "âœ… All validation checks passed! Ready to push."